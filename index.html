<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mega Store - official</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg: #0f172a;
            --text: #ffffff;
            --card: rgba(255, 255, 255, 0.1);
            --primary: #6366f1;
            --glass-border: rgba(255, 255, 255, 0.2);
            --star: #ffb400;
            --bg-animation-duration: 15s; /* animation time (can be changed via slider) */
        }

        /* dark-mode (night) */
        .dark-mode {
            --bg: #0b0e14;
            --text: #fff;
            --card: rgba(255,255,255,0.05);
            --glass-border: rgba(255,255,255,0.06);
            --primary: #6366f1;
            --star: #ffb400;
        }

        /* light / white mode */
        .light-mode {
            --bg: #f8fafc;
            --text: #0b1220;
            --card: rgba(11,18,32,0.03);
            --glass-border: rgba(11,18,32,0.06);
            --primary: #2563eb;
            --star: #c27800;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: var(--text); padding-bottom: 120px; overflow-x: hidden; position: relative; transition: background 0.45s ease, color 0.45s ease; }

        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.2) 0%, transparent 40%),
                        radial-gradient(circle at 80% 70%, rgba(244, 114, 182, 0.2) 0%, transparent 40%);
            z-index: -1;
            animation: bgMove var(--bg-animation-duration) infinite alternate ease-in-out;
        }
        @keyframes bgMove { 0% { transform: scale(1) translate(0, 0); } 100% { transform: scale(1.2) translate(20px, 20px); } }

        /* Header: changed background color to a soft gradient */
        header { padding: 12px 15px; position: sticky; top: 0; z-index: 1000; background: linear-gradient(90deg, rgba(99,102,241,0.25), rgba(244,114,182,0.18)); backdrop-filter: blur(15px); display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--glass-border); }
        .brand { font-size: 20px; font-weight: 900; background: linear-gradient(to right, #818cf8, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .search-container { background: var(--card); border-radius: 20px; display: flex; align-items: center; padding: 5px 15px; width: 65%; height: 38px; border: 1px solid var(--glass-border); }
        .search-container input { border: none; background: transparent; width: 100%; outline: none; color: var(--text); font-size: 14px; margin-left: 8px; }

        .theme-controls { display:flex; align-items:center; gap:8px; }
        .moon-btn, .sun-btn { font-size:22px; cursor:pointer; padding:4px; border-radius:8px; color: inherit; }
        .moon-btn.active, .sun-btn.active { color:var(--primary); text-shadow:0 0 12px rgba(99,102,241,0.3); }

        .section { margin-top: 25px; padding: 0 15px; }
        .sec-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .sec-title { font-size: 18px; font-weight: 800; border-left: 4px solid var(--primary); padding-left: 10px; }
        .see-more { color: var(--primary); font-size: 13px; font-weight: 700; cursor: pointer; }

        .top-banner-row { display: flex; gap: 12px; overflow-x: auto; scrollbar-width: none; padding-bottom: 10px; }
        .top-banner-card { min-width: 280px; height: 160px; border-radius: 20px; background: var(--card); border: 1px solid var(--glass-border); overflow: hidden; position: relative; flex-shrink: 0; cursor: pointer; backdrop-filter: blur(10px); }
        .top-banner-card img { width: 100%; height: 100%; object-fit: cover; }
        .banner-info { position: absolute; bottom: 0; left: 0; right: 0; padding: 10px; background: linear-gradient(transparent, rgba(0,0,0,0.8)); color: var(--text); font-size: 14px; font-weight: bold; }

        .app-row { display: flex; gap: 15px; overflow-x: auto; scrollbar-width: none; padding-bottom: 10px; }
        .app-card { min-width: 105px; max-width: 105px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; background: var(--card); padding: 10px; border-radius: 22px; border: 1px solid var(--glass-border); backdrop-filter: blur(5px); position: relative; }
        .icon-box { width: 85px; height: 85px; border-radius: 18px; overflow: hidden; margin-bottom: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); }
        .icon-box img { width:100%; height:100%; object-fit:cover; }
        .app-name { font-size: 12px; font-weight: 600; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 6px; color: var(--text); }

        /* NEW: small inline stats under each app icon */
        .app-stats { display:flex; gap:8px; align-items:center; font-size:11px; color: #9aa3c7; }
        .app-stats .stat { display:flex; gap:6px; align-items:center; padding:4px 6px; border-radius:12px; background: rgba(0,0,0,0.06); border: 1px solid var(--glass-border); }
        .app-stats .stat i { color: var(--primary); font-size:12px; }
        .app-stats .stat .num { font-weight:700; color:var(--text); font-size:12px; }

        .bottom-nav { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 90%; background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); border-radius: 30px; display:flex; justify-content: space-around; padding:12px; border:1px solid var(--glass-border); box-shadow:0 10px 40px rgba(0,0,0,0.4); z-index:2000; }
        .nav-item { text-align:center; color:#888; font-size:11px; cursor:pointer; flex:1; }
        .nav-item i { display:block; font-size:22px; margin-bottom:5px; }
        .nav-item.active { color:var(--primary); font-weight:bold; text-shadow:0 0 10px var(--primary); }

        .modal, .modal-full { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:5000; align-items:center; justify-content:center; backdrop-filter: blur(8px); }
        .modal-full { background: var(--bg); overflow-y:auto; padding:20px; z-index:6000; flex-direction:column; }

        /* NEW: modal content wrapper so dropdowns render above overlay */
        .modal .modal-content {
            width:100%;
            max-width:820px;
            background:var(--bg);
            border-radius:12px;
            padding:18px;
            border:1px solid var(--glass-border);
            position: relative; /* create stacking context for inner content */
            z-index: 6001;     /* higher than parent's z-index to ensure selects render correctly */
            overflow: visible; /* allow custom dropdown to overflow */
        }

        /* When upload modal is full-screen make modal-content fill and scroll */
        .modal-full .modal-content {
            width:100%;
            max-width: 1100px;
            height: calc(100vh - 60px);
            max-height: calc(100vh - 60px);
            border-radius: 12px;
            padding: 18px;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.6);
            border: 1px solid var(--glass-border);
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
        }

        input, select, textarea { width:100%; padding:12px; margin:8px 0; border-radius:15px; border:1px solid var(--glass-border); background: rgba(255,255,255,0.05); color:var(--text); outline:none; }

        /* Ensure select dropdown appears above overlay and other stacking contexts */
        .modal select, .modal input, .modal textarea, .modal .img-preview {
            position: relative;
            z-index: 6002;
        }

        /* On some browsers, appearance affects dropdown; ensure native appearance */
        .modal select { -webkit-appearance: menulist-button; appearance: auto; }

        .btn-download { width:100%; padding:15px; background: linear-gradient(to right, var(--primary), #a855f7); color:#fff; border:none; border-radius:15px; font-weight:bold; font-size:16px; margin:20px 0; box-shadow:0 4px 15px rgba(99,102,241,0.4); }

        .comment-section { margin-top:30px; padding-top:20px; border-top:1px solid var(--glass-border); }
        .comment-item { background: var(--card); padding:12px; border-radius:15px; margin-bottom:10px; border:1px solid var(--glass-border); }
        .comment-user { font-weight:bold; color:var(--primary); font-size:13px; margin-bottom:4px; }
        .comment-text { font-size:14px; opacity:0.95; margin-bottom:6px; color:var(--text); }
        .comment-date { font-size:12px; color:#9aa3c7; }

        .stat-box { display:flex; justify-content:space-around; padding:15px 0; border-top:1px solid var(--glass-border); border-bottom:1px solid var(--glass-border); text-align:center; margin:10px 0; }

        .zoom-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:10000; align-items:center; justify-content:center; }
        .zoom-overlay img { max-width:95%; max-height:80%; border-radius:10px; box-shadow:0 0 20px rgba(255,255,255,0.2); }
        .close-zoom { position:absolute; top:30px; left:20px; color:white; font-size:24px; cursor:pointer; }

        .ss-img { height:220px; border-radius:10px; cursor:pointer; transition: transform 0.2s; }
        .ss-img:active { transform: scale(0.95); }

        .share-btn { padding:10px 12px; border-radius:12px; border:none; cursor:pointer; font-weight:700; display:inline-flex; gap:8px; align-items:center; justify-content:center; }
        .share-primary { background: linear-gradient(to right, #06b6d4, #3b82f6); color: #fff; }

        /* styling for links inside description */
        .desc a { color: var(--primary); text-decoration: underline; cursor: pointer; }

        /* News specific - increased thumbnail size and responsive layout */
        .news-card { display:flex; gap:12px; background:var(--card); padding:12px; border-radius:12px; border:1px solid var(--glass-border); align-items:center; cursor:pointer; transition: 0.2s; }
        .news-card:hover { transform: translateY(-4px); }
        .news-thumb { width:220px; height:160px; border-radius:8px; overflow:hidden; flex-shrink:0; }
        .news-thumb img { width:100%; height:100%; object-fit:cover; display:block; }
        .news-meta { flex:1; }
        .news-title { font-weight:800; font-size:18px; color:var(--text); margin-bottom:6px; }
        .news-desc { font-size:14px; color:gray; max-height:80px; overflow:hidden; text-overflow:ellipsis; }
        .open-news-link { display:inline-block; margin-top:8px; padding:8px 12px; background: linear-gradient(to right, #06b6d4, #3b82f6); color:#fff; border-radius:10px; text-decoration:none; font-weight:700; }
        .open-news-link:active { transform: translateY(1px); }

        /* large news detail inline */
        .news-detail { display:flex; flex-direction:column; gap:12px; }
        .news-detail .hero { width:100%; border-radius:12px; overflow:hidden; }
        .news-detail .hero img { width:100%; height:auto; display:block; object-fit:cover; }
        .news-detail .back-btn { color:var(--primary); font-weight:700; cursor:pointer; margin-bottom:6px; }

        @media (max-width: 700px) {
            .search-container { width: 55%; }
            #searchResults { grid-template-columns: repeat(2, 1fr) !important; }
            .news-card { flex-direction: column; align-items: flex-start; }
            .news-thumb { width:100%; height:220px; }
            .news-title { font-size:16px; }

            /* make upload modal content full width on small screens */
            .modal-full .modal-content {
                max-width: 96%;
                height: calc(100vh - 40px);
                max-height: calc(100vh - 40px);
                padding: 12px;
            }
        }

        /* like button active style */
        .like-active { background: linear-gradient(to right, #ff6b6b, #ffb86b); color: #fff; border-radius:12px; padding:10px 12px; display:inline-flex; gap:8px; align-items:center; cursor:pointer; font-weight:700; border:none; }
        .img-preview { width: 100px; height: 70px; object-fit: cover; border-radius:8px; border:1px solid var(--glass-border); display:block; margin-top:6px; }

        /* small/large preview variants (user toggle) */
        .img-preview.small { width: 60px; height: 42px; }
        .img-preview.large { width: 200px; height: 140px; }

        /* upload time small text in modal */
        .upload-time-small { color:gray; font-size:13px; margin-top:6px; }

        /* Custom select styles (mobile-friendly, avoids native select popup issues) */
        .custom-select {
          background: rgba(255,255,255,0.03);
          border: 1px solid var(--glass-border);
          border-radius: 15px;
          padding: 10px 12px;
          color: var(--text);
          cursor: pointer;
          position: relative;
          user-select: none;
          display: inline-block;
          width: 100%;
        }
        .custom-select .selected {
          font-weight: 700;
          display:flex;
          justify-content:space-between;
          align-items:center;
          gap:8px;
        }
        .custom-select .selected::after {
          content: "▾";
          opacity: 0.8;
          font-size: 14px;
        }
        .custom-select .options {
          position: absolute;
          left: 0;
          right: 0;
          top: calc(100% + 8px);
          background: var(--bg);
          border-radius: 12px;
          border: 1px solid var(--glass-border);
          box-shadow: 0 10px 30px rgba(0,0,0,0.5);
          z-index: 100000 !important; /* make sure it's on top */
          max-height: 260px;
          overflow-y: auto;
          display: none;
          padding: 6px;
        }
        .custom-select.open .options { display: block; }
        .custom-select .option {
          padding: 10px 12px;
          border-radius: 10px;
          cursor: pointer;
          color: var(--text);
        }
        .custom-select .option:hover, .custom-select .option.active {
          background: rgba(99,102,241,0.12);
          color: var(--primary);
        }
    </style>
</head>
<body onload="initApp()">
<header>
    <div class="brand">Mega store</div>
    <div class="search-container">
        <i class="fa-solid fa-magnifying-glass" style="opacity: 0.5;"></i>
        <input type="text" id="searchInput" placeholder="Search..." oninput="doSearch()">
    </div>

    <div class="theme-controls">
        <!-- Theme toggle (dark <-> light) -->
        <i id="themeBtn" class="fa-solid fa-moon moon-btn" onclick="toggleTheme()" title="Toggle theme"></i>
    </div>
</header>

<div id="search-view" style="display:none; padding: 20px;">
    <h2 style="margin-bottom:15px;">Search Results</h2>
    <div id="searchResults" style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 15px;"></div>
</div>

<div id="news-view" style="display:none; padding: 20px;">
    <h2 style="margin-bottom:15px;">News</h2>
    <div id="newsList" style="display:grid; grid-template-columns: repeat(1, 1fr); gap: 12px;"></div>
</div>

<div id="home-view">
    <div id="main-content-home">
        <div class="section">
            <div class="sec-header"><div class="sec-title">Top Project</div></div>
            <div id="grid-top" class="top-banner-row"></div>
        </div>

        <!-- NEW main "New" section -->
        <div class="section">
            <div class="sec-header"><div class="sec-title">New</div><div class="see-more" onclick="goToAll()">See more</div></div>
            <div id="grid-new-main" class="app-row"></div>
        </div>

        <div class="section">
            <div class="sec-header"><div class="sec-title">Trending</div><div class="see-more" onclick="goToAll()">See more</div></div>
            <div id="grid-trending" class="app-row"></div>
        </div>
        <div class="section">
            <div class="sec-header"><div class="sec-title">New & Updated</div><div class="see-more" onclick="goToAll()">See more</div></div>
            <div id="grid-new" class="app-row"></div>
        </div>
        <div class="section">
            <div class="sec-header"><div class="sec-title">Editor's choice</div><div class="see-more" onclick="goToAll()">See more</div></div>
            <div id="grid-editor" class="app-row"></div>
        </div>
    </div>
</div>

<div id="all-view" style="display:none; padding: 20px;">
    <h2 style="margin-bottom:15px;">All projects</h2>
    <div id="grid-all" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; row-gap: 25px;"></div>
</div>

<div id="detailPage" class="modal-full"><div id="detailContent"></div></div>

<!-- Upload modal (full-screen now). Upload button is available at top and bottom of the form.
     NOTE: the note text has been removed as requested. -->
<div id="uploadModal" class="modal-full" onclick="if(event.target===this) closeUploadModal()">
  <div class="modal-content" onclick="event.stopPropagation()">

    <div style="display:flex; justify-content:flex-start; align-items:center; gap:8px;">
      <h3 style="margin:0;">Upload New App</h3>
    </div>

    <div style="margin-top:12px;">
      <input id="u_name" placeholder="Project Name" />
      <input id="u_dev" placeholder="Developer" value="Sketchwar" />
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <input id="u_rating" placeholder="Rating (e.g. 4.5)" value="4.5" />

        <!-- Kept only the two requested categories: New, New & Updated -->
        <input type="hidden" id="u_cat" value="New">
        <div style="position:relative;">
          <div id="u_cat_custom" class="custom-select" role="listbox" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
            <div class="selected">New</div>
            <div class="options" aria-hidden="true">
              <div class="option">New</div>
              <div class="option">New &amp; Updated</div>
            </div>
          </div>
        </div>

      </div>

      <!-- FILE INPUTS: icon + 4 screenshots (same number as before).
           Added data-model="image" attributes so it's explicit these are image uploads. -->
      <label style="font-size:13px;margin-top:6px;">Icon (required)</label>
      <div style="font-size:12px;color:gray;margin-bottom:6px;">Upload images only (icon + screenshots). <small style="color:#9aa3c7;">data-model="image"</small></div>
      <input id="u_icon_file" type="file" accept="image/*" data-model="image" />
      <img id="u_icon_preview" class="img-preview small" style="display:none;">

      <textarea id="u_desc" placeholder="Description"></textarea>
      <input id="u_link" placeholder="Download Link or URL" />
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div>
          <label style="font-size:13px">Screenshot 1</label>
          <input id="u_s1_file" type="file" accept="image/*" data-model="image" />
          <img id="u_s1_preview" class="img-preview small" style="display:none;">
        </div>
        <div>
          <label style="font-size:13px">Screenshot 2</label>
          <input id="u_s2_file" type="file" accept="image/*" data-model="image" />
          <img id="u_s2_preview" class="img-preview small" style="display:none;">
        </div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:6px;">
        <div>
          <label style="font-size:13px">Screenshot 3</label>
          <input id="u_s3_file" type="file" accept="image/*" data-model="image" />
          <img id="u_s3_preview" class="img-preview small" style="display:none;">
        </div>
        <div>
          <label style="font-size:13px">Screenshot 4</label>
          <input id="u_s4_file" type="file" accept="image/*" data-model="image" />
          <img id="u_s4_preview" class="img-preview small" style="display:none;">
        </div>
      </div>

      <!-- Preview size toggle -->
      <div style="margin-top:8px; display:flex; align-items:center; gap:10px;">
        <input type="checkbox" id="u_preview_small" checked />
        <label for="u_preview_small" style="font-size:13px;color:gray;">Small previews (avoids large image previews)</label>
      </div>

      <div style="margin-top:12px; display:flex; gap:10px;">
        <button id="submitUploadBtn" class="btn-download" onclick="submitUpload()">Upload App</button>
        <!-- "Chanchal" replaced with "Back" and wired to close modal + return to home screen -->
        <button id="uploadBackBtn" class="share-btn" style="align-self:center;" onclick="closeUploadModal(); tab('home', document.getElementById('nav-home'));">Back</button>
      </div>

      <!-- upload time display -->
      <div id="uploadTimeDisplayUser" class="upload-time-small"></div>
      <!-- upload progress for user modal -->
      <div id="uploadProgressUser" class="upload-time-small" style="margin-top:6px;"></div>

    </div>
  </div>
</div>

<div id="zoomOverlay" class="zoom-overlay" onclick="this.style.display='none'">
    <i class="fa-solid fa-arrow-left close-zoom"></i>
    <img id="zoomImg" src="">
</div>

<nav class="bottom-nav">
    <div class="nav-item active" id="nav-home" onclick="tab('home', this)"><i class="fa-solid fa-house"></i>Home</div>
    <div class="nav-item" id="nav-all" onclick="tab('all', this)"><i class="fa-solid fa-layer-group"></i>All apps</div>
    <div class="nav-item" id="nav-news" onclick="tab('news', this)"><i class="fa-solid fa-newspaper"></i>News</div>
    <!-- Upload nav item added at bottom as requested -->
    <div class="nav-item" id="nav-upload" onclick="openUploadModal()"><i class="fa-solid fa-upload"></i>Upload</div>
    <!-- Replaced Telegram with YouTube button per request -->
    <div class="nav-item" id="nav-youtube" onclick="window.open('https://www.youtube.com/@kapil_h4x_live', '_blank')" style="color:#ff0000;"><i class="fa-brands fa-youtube"></i>YouTube</div>
</nav>

<script type="module">
/*
  Changes in this version:
  - Upload modal changed to full-screen (.modal-full). Modal content fills most of viewport and scrolls internally.
  - Added client-side image compression + upload progress reporting for user uploads.
  - Uses uploadBytesResumable when Firebase Storage available for per-file progress.
  - Shows overall progress in #uploadProgressUser and upload time in #uploadTimeDisplayUser.
  - No other behavior logic changed.
*/

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
import { push, ref as rdbRef, set, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
import { getStorage, ref as storageRef, uploadBytes, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCY6B4hsteNbRkNKYS6f9M1ob9030AvF4k",
  authDomain: "mega-boost-official-website.firebaseapp.com",
  databaseURL: "https://mega-boost-official-website-default-rtdb.firebaseio.com",
  projectId: "mega-boost-official-website",
  storageBucket: "mega-boost-official-website.firebasestorage.app",
  messagingSenderId: "220450956022",
  appId: "1:220450956022:web:c0d9cdc97ecefa1f2d02d7",
  measurementId: "G-LN9QJ0Y938"
};

let fbAvailable = false;
let rdb = null;
let storage = null;
try {
    const fbApp = initializeApp(firebaseConfig);
    rdb = getDatabase(fbApp);
    storage = getStorage(fbApp);
    fbAvailable = true;
    console.log("Firebase initialized (read-only on index).");
} catch (e) {
    console.warn("Firebase init failed - fallback to local/jsonbin only.", e);
}

/* GLOBAL API CONFIG (jsonbin for app catalog backup) */
const BIN_ID = '658b0f80dc7465401889980b';
const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
const DB_KEY = "MEGA_STORE_FINAL_DB";
const COMMENT_KEY = "MEGA_STORE_COMMENTS";
const USER_NAME_KEY = "MEGA_STORE_USER_NAME";
const NEWS_KEY = "MEGA_STORE_NEWS"; // new key for news
const LIKES_KEY = "MEGA_STORE_LIKES";
const VIEWS_KEY = "MEGA_STORE_VIEWS";

/* in-memory caches */
let db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
let commentsDB = JSON.parse(localStorage.getItem(COMMENT_KEY)) || {};
let newsDB = JSON.parse(localStorage.getItem(NEWS_KEY)) || [];
let likesDB = JSON.parse(localStorage.getItem(LIKES_KEY)) || {}; // structure: { appId: { userId: true } }
let viewsDB = JSON.parse(localStorage.getItem(VIEWS_KEY)) || {}; // structure: { appId: { userId: true } }
let currentTab = 'home';
let currentDetailId = null;

/* If Firebase available, attach listeners for apps, comments, news, likes, views (read-only listeners) */
if (fbAvailable && rdb) {
    // apps listener -> keep db updated in real time
    try {
        onValue(ref(rdb, 'apps'), (snap) => {
            const val = snap.val() || {};
            db = Object.keys(val).map(k => val[k]);
            db.sort((a,b) => (b.id || 0) - (a.id || 0));
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            render();
            const idFromUrl = getAppIdFromUrl();
            if (idFromUrl && !currentDetailId) {
                const idNum = Number(idFromUrl);
                if (!isNaN(idNum)) openDetail(idNum, true);
            }
        }, (err) => {
            console.warn("Firebase apps listener error:", err);
        });
    } catch (e) {
        console.warn("Unable to attach apps listener:", e);
    }

    // comments listener -> keep commentsDB updated
    try {
        onValue(ref(rdb, 'comments'), (snap) => {
            const val = snap.val() || {};
            commentsDB = val;
            localStorage.setItem(COMMENT_KEY, JSON.stringify(commentsDB));
            if (currentDetailId) openDetail(currentDetailId, true);
        }, (err) => {
            console.warn("Firebase comments listener error:", err);
        });
    } catch (e) {
        console.warn("Unable to attach comments listener:", e);
    }

    // news listener -> keep newsDB updated
    try {
        onValue(ref(rdb, 'news'), (snap) => {
            const val = snap.val() || {};
            // convert to array
            newsDB = Object.keys(val).map(k => val[k]);
            newsDB.sort((a,b) => (b.id || 0) - (a.id || 0));
            localStorage.setItem(NEWS_KEY, JSON.stringify(newsDB));
            renderNews();
        }, (err) => {
            console.warn("Firebase news listener error:", err);
        });
    } catch (e) {
        console.warn("Unable to attach news listener:", e);
    }

    // likes listener -> keep likesDB updated
    try {
        onValue(ref(rdb, 'likes'), (snap) => {
            const val = snap.val() || {};
            // val structure expected: { appId: { userId: true } }
            likesDB = val;
            localStorage.setItem(LIKES_KEY, JSON.stringify(likesDB));
            // update UI: detail counts + grid
            if (currentDetailId) updateDetailStats(currentDetailId);
            render();
        }, (err) => {
            console.warn("Firebase likes listener error:", err);
        });
    } catch (e) {
        console.warn("Unable to attach likes listener:", e);
    }

    // views listener -> keep viewsDB updated
    try {
        onValue(ref(rdb, 'views'), (snap) => {
            const val = snap.val() || {};
            // val structure expected: { appId: { userId: true } }
            viewsDB = val;
            localStorage.setItem(VIEWS_KEY, JSON.stringify(viewsDB));
            if (currentDetailId) updateDetailStats(currentDetailId);
            render();
        }, (err) => {
            console.warn("Firebase views listener error:", err);
        });
    } catch (e) {
        console.warn("Unable to attach views listener:", e);
    }
}

/* Theme + Animation helpers (unchanged) */
function setTheme(theme) {
    const body = document.body;
    const btn = document.getElementById('themeBtn');
    body.classList.remove('dark-mode', 'light-mode');
    if (theme === 'light') {
        body.classList.add('light-mode');
        if (btn) {
            btn.classList.remove('fa-moon');
            btn.classList.add('fa-sun');
            btn.classList.add('active');
        }
    } else {
        body.classList.add('dark-mode');
        if (btn) {
            btn.classList.remove('fa-sun');
            btn.classList.add('fa-moon');
            btn.classList.remove('active');
        }
    }
    localStorage.setItem('MEGA_THEME', theme);
}
window.setTheme = setTheme;
function toggleTheme() {
    const current = localStorage.getItem('MEGA_THEME') || 'dark';
    const next = current === 'dark' ? 'light' : 'dark';
    setTheme(next);
}
window.toggleTheme = toggleTheme;
window.toggleNightMode = toggleTheme;

/* Utility functions */
function getAppIdFromUrl() {
    try {
        const url = new URL(window.location.href);
        const q = url.searchParams.get('app');
        if (q) return q;
        if (window.location.hash && window.location.hash.includes('app=')) {
            const parts = window.location.hash.replace('#','').split('=');
            if (parts[0] === 'app' && parts[1]) return parts[1];
        }
    } catch (e) {}
    return null;
}
function clearAppFromUrl() {
    try { history.replaceState({}, '', location.pathname); } catch (e) {}
}
function escapeHtml(str) {
    if (typeof str !== 'string') return '';
    return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}
function linkify(text) {
    if (!text) return '';
    const escaped = escapeHtml(text);
    const withBreaks = escaped.replace(/\r\n|\r|\n/g, '<br>');
    const urlRegex = /(\b(https?:\/\/|www\.)[^\s<]+)/gi;
    const linked = withBreaks.replace(urlRegex, function(m) {
        let url = m;
        if (!/^https?:\/\//i.test(url)) {
            url = 'https://' + url;
        }
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${m}</a>`;
    });
    return linked;
}

/* Ensure we have a stable userId for per-account constraints.
   Prefer USER_NAME_KEY if present; otherwise fallback to generated ID stored in localStorage as MEGA_USER_ID.
   This is a client-side "account" heuristic — if you want server-auth enforcement, integrate real auth.
*/
function ensureUserId() {
    let userName = localStorage.getItem(USER_NAME_KEY);
    if (userName && userName.trim() !== '') {
        return 'u_' + userName.trim().replace(/\s+/g, '_').toLowerCase();
    }
    let uid = localStorage.getItem('MEGA_USER_ID');
    if (!uid) {
        uid = 'anon_' + Date.now() + '_' + Math.floor(Math.random()*10000);
        localStorage.setItem('MEGA_USER_ID', uid);
    }
    return uid;
}

/* Initialize app: restore theme, load local cache, then jsonbin fallback */
async function initApp() {
    const savedTheme = localStorage.getItem('MEGA_THEME') || 'dark';
    setTheme(savedTheme);
    const savedAnim = localStorage.getItem('MEGA_BG_ANIM') || '15';
    document.documentElement.style.setProperty('--bg-animation-duration', savedAnim + 's');

    // Load likes/views caches from localStorage
    likesDB = JSON.parse(localStorage.getItem(LIKES_KEY)) || likesDB;
    viewsDB = JSON.parse(localStorage.getItem(VIEWS_KEY)) || viewsDB;

    // setup small previews on upload modal file inputs
    ['u_icon_file','u_s1_file','u_s2_file','u_s3_file','u_s4_file'].forEach(id=>{
        const inp = document.getElementById(id);
        if(inp){
            inp.addEventListener('change', ()=>{
                const f = inp.files && inp.files[0];
                const pid = id.replace('_file','_preview');
                const pimg = document.getElementById(pid);
                if(f && pimg){
                    pimg.src = URL.createObjectURL(f);
                    const small = document.getElementById('u_preview_small') ? document.getElementById('u_preview_small').checked : true;
                    pimg.classList.remove('small','large');
                    pimg.classList.add(small ? 'small' : 'large');
                    pimg.style.display = 'block';
                } else if(pimg){
                    pimg.style.display='none'; pimg.src='';
                }
            });
        }
    });

    // when toggle changes, update existing previews size
    const previewToggle = document.getElementById('u_preview_small');
    if (previewToggle) {
      previewToggle.addEventListener('change', ()=>{
        const small = previewToggle.checked;
        ['u_icon_preview','u_s1_preview','u_s2_preview','u_s3_preview','u_s4_preview'].forEach(pid=>{
            const pimg = document.getElementById(pid);
            if (pimg && pimg.src) {
                pimg.classList.remove('small','large');
                pimg.classList.add(small ? 'small' : 'large');
            }
        });
      });
    }

    render();
    renderNews();

    // initialize custom select AFTER DOM + render
    try { initCustomSelect(); } catch(e){ console.warn('initCustomSelect error', e); }

    const idFromUrl = getAppIdFromUrl();
    if (idFromUrl) {
        const idNum = Number(idFromUrl);
        if (!isNaN(idNum)) {
            const exists = db.find(x => Number(x.id) === idNum);
            if (exists) openDetail(idNum, true);
        }
    }

    try {
        const response = await fetch(API_URL + '/latest');
        const result = await response.json();
        if (result.record && Array.isArray(result.record) && result.record.length) {
            if (!fbAvailable || (fbAvailable && (!db || db.length === 0))) {
                db = result.record;
                localStorage.setItem(DB_KEY, JSON.stringify(db));
                render();
                const idFromUrl2 = getAppIdFromUrl();
                if (idFromUrl2) {
                    const idNum = Number(idFromUrl2);
                    if (!isNaN(idNum)) openDetail(idNum, true);
                }
            }
        }
    } catch (error) {
        console.log("jsonbin fetch failed, using local data.");
    }
}
window.initApp = initApp;

/* popstate handler */
window.onpopstate = function(event) {
    if(document.getElementById('zoomOverlay') && document.getElementById('zoomOverlay').style.display === 'flex') {
        document.getElementById('zoomOverlay').style.display = 'none';
        return;
    }
    closeAll();
};

/* Close modals and clear detail state */
function closeAll() {
    document.querySelectorAll('.modal, .modal-full').forEach(m => m.style.display='none');
    currentDetailId = null;
    clearAppFromUrl();
}
window.closeAll = closeAll;

/* Helper: safe count accessor */
function countFor(obj, key) {
    const group = obj && obj[key] ? obj[key] : {};
    return Object.keys(group).length;
}

/* ------------------ User: compress + upload with progress helpers ------------------ */

// Compress image file to a Blob (WebP preferred). Returns Blob.
function compressImageUser(file, maxWidth = 1024, quality = 0.75, mimeType = 'image/webp') {
  return new Promise((resolve, reject) => {
    if (!file || !file.type.startsWith('image/')) return reject(new Error('Not an image'));
    const img = new Image();
    const reader = new FileReader();
    reader.onerror = (e) => reject(e);
    reader.onload = () => {
      img.onload = () => {
        try {
          const scale = Math.min(1, maxWidth / img.width);
          const w = Math.round(img.width * scale);
          const h = Math.round(img.height * scale);
          const canvas = document.createElement('canvas');
          canvas.width = w;
          canvas.height = h;
          canvas.getContext('2d').drawImage(img, 0, 0, w, h);
          canvas.toBlob((blob) => {
            if (!blob) return reject(new Error('Compression failed'));
            resolve(blob);
          }, mimeType, quality);
        } catch (err) {
          reject(err);
        }
      };
      img.onerror = (e) => reject(e);
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });
}

// Convert file to dataURL with progress reporting via onProgress(percent)
function fileToDataURLWithProgressUser(file, onProgress) {
  return new Promise((res, rej) => {
    const reader = new FileReader();
    reader.onprogress = (ev) => {
      if (ev.lengthComputable && typeof onProgress === 'function') {
        const p = Math.round((ev.loaded / ev.total) * 100);
        try { onProgress(p); } catch (e) {}
      }
    };
    reader.onload = () => res(reader.result);
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
}

// Upload (or convert) file with progress callback. Returns URL (downloadURL or dataURL).
async function uploadFileToStorage_User(file, path, onProgress) {
  if (!file) return '';
  let blob;
  try {
    blob = await compressImageUser(file, 1024, 0.75, 'image/webp');
  } catch (e) {
    blob = file;
  }

  if (fbAvailable && storage) {
    try {
      const sRef = storageRef(storage, path);
      const uploadTask = uploadBytesResumable(sRef, blob, { contentType: blob.type || file.type });
      return await new Promise((resolve, reject) => {
        uploadTask.on('state_changed',
          (snapshot) => {
            const percent = snapshot.totalBytes ? Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100) : 0;
            if (typeof onProgress === 'function') onProgress(percent);
          },
          (error) => {
            console.warn('Firebase upload failed - fallback to dataURL', error);
            fileToDataURLWithProgressUser(file, onProgress).then(url => resolve(url)).catch(err => reject(err));
          },
          async () => {
            try {
              const url = await getDownloadURL(uploadTask.snapshot.ref);
              if (typeof onProgress === 'function') onProgress(100);
              resolve(url);
            } catch (e) { reject(e); }
          }
        );
      });
    } catch (e) {
      console.warn('uploadFileToStorage_User firebase path error', e);
      return await fileToDataURLWithProgressUser(file, onProgress);
    }
  } else {
    return await fileToDataURLWithProgressUser(file, onProgress);
  }
}

// Sequential uploader for user uploads
async function uploadFilesSequential_User(uploadList, overallProgressCb) {
  const total = uploadList.length || 0;
  let done = 0;
  const results = [];
  for (let i = 0; i < uploadList.length; i++) {
    const item = uploadList[i];
    try {
      const url = await uploadFileToStorage_User(item.file, item.path, (filePercent) => {
        const overall = total ? Math.round(((done + (filePercent / 100)) / total) * 100) : 100;
        if (typeof overallProgressCb === 'function') overallProgressCb(overall, done, filePercent, i);
      });
      results.push(url);
      done++;
      if (typeof overallProgressCb === 'function') overallProgressCb(Math.round((done / total) * 100), done, 100, i);
    } catch (e) {
      console.warn('uploadFilesSequential_User error for item', item, e);
      results.push('');
    }
  }
  return results;
}

function setUserUploadProgress(text) {
  const el = document.getElementById('uploadProgressUser');
  if (el) el.innerText = text;
}

/* ---------------- end user upload helpers ------------------ */

/* Render app grid (read-only) -- replaced star with views & likes stats
   CHANGE: Top Project will also be inserted into the All projects grid.
   Added mapping for new main "New" section (grid-new-main).
   Also added "Sylhet" mapping to appear in the New main section as requested
*/
function render() {
    const grids = {
        "Trending": "grid-trending",
        "New & Updated": "grid-new",
        "Editor's choice": "grid-editor",
        "New": "grid-new-main", // <-- added main New mapping
        "Sylhet": "grid-new-main" // Sylhet items also go into the New main section as requested
    };
    const counts = { "Trending": 0, "New & Updated": 0, "Editor's choice": 0, "New": 0, "Sylhet": 0 };
    Object.values(grids).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = "";
    });
    const topEl = document.getElementById('grid-top'); if (topEl) topEl.innerHTML = "";
    const allEl = document.getElementById('grid-all'); if (allEl) allEl.innerHTML = "";

    db.forEach(p => {
        // compute counts from likesDB / viewsDB
        const likesCount = countFor(likesDB, p.id);
        const viewsCount = countFor(viewsDB, p.id);

        const statsHTML = `<div class="app-stats">
                              <div class="stat" title="Views"><i class="fa-solid fa-eye"></i><div class="num">${escapeHtml(String(viewsCount || 0))}</div></div>
                              <div class="stat" title="Likes"><i class="fa-solid fa-heart"></i><div class="num">${escapeHtml(String(likesCount || 0))}</div></div>
                           </div>`;

        const html = `<div class="app-card" onclick="openDetail(${p.id})">
                        <div class="icon-box"><img src="${p.icon}" onerror="this.src='https://via.placeholder.com/150'"></div>
                        <div class="app-name">${escapeHtml(p.name)}</div>
                        ${statsHTML}
                      </div>`;

        if (p.cat === "Top Project") {
            const topHTML = `<div class="top-banner-card" onclick="openDetail(${p.id})"><img src="${p.banner || p.icon}" onerror="this.src='https://via.placeholder.com/300x150'"><div class="banner-info">${escapeHtml(p.name)}</div></div>`;
            if (topEl) topEl.innerHTML += topHTML;
            // also add to All projects grid
            if (allEl) allEl.innerHTML += html;
        } else {
            // If p.cat matches one of our grid keys and we haven't exceeded a short preview count, add to that grid
            if (grids[p.cat] && counts[p.cat] < 5) {
                const el = document.getElementById(grids[p.cat]);
                if (el) el.innerHTML += html;
                counts[p.cat]++;
            }
            if (allEl) allEl.innerHTML += html;
        }
    });
}

/* Render News list (read-only) */
function renderNews(filtered) {
    const list = document.getElementById('newsList');
    if (!list) return;
    const items = Array.isArray(filtered) ? filtered : newsDB;
    if (!items || items.length === 0) {
        list.innerHTML = `<p style="color:gray;">No news yet.</p>`;
        return;
    }
    let html = '';
    items.forEach(n => {
        html += `<div class="news-card" onclick="showNewsInline(${n.id})">
            <div class="news-thumb"><img src="${n.img}" onerror="this.src='https://via.placeholder.com/800x420'"></div>
            <div class="news-meta">
                <div class="news-title">${escapeHtml(n.title)}</div>
                <div class="news-desc">${escapeHtml(n.desc || '').slice(0,240)}</div>
                ${n.link ? `<div><a href="${n.link}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();" class="open-news-link">Open Link</a></div>` : ''}
            </div>
        </div>`;
    });
    list.innerHTML = html;
}
window.renderNews = renderNews;

/* Show news inline */
function showNewsInline(id) {
    const n = newsDB.find(x => Number(x.id) === Number(id));
    if (!n) return alert("News not found");
    const list = document.getElementById('newsList');
    if (!list) return;
    list.innerHTML = `
        <div class="news-detail">
            <div class="back-btn" onclick="renderNews();">${'← Back to list'}</div>
            <div class="hero"><img src="${n.img}" alt="${escapeHtml(n.title)}" onerror="this.src='https://via.placeholder.com/1200x700'"></div>
            <div style="font-weight:800; font-size:20px;">${escapeHtml(n.title)}</div>
            <div style="color:gray; line-height:1.6;">${linkify(n.desc || '')}</div>
            ${n.link ? `<button class="btn-download" onclick="window.open('${n.link}', '_blank')">Open Link</button>` : ''}
        </div>
    `;
    document.getElementById('news-view').style.display = 'block';
    document.getElementById('home-view').style.display = 'none';
    document.getElementById('all-view').style.display = 'none';
    document.getElementById('search-view').style.display = 'none';
}
window.showNewsInline = showNewsInline;

/* openDetail: shows project + comments (read-only view) and registers a single view per account */
function openDetail(id, skipPush) {
    const p = db.find(x => Number(x.id) === Number(id));
    if (!p) return alert("Project not found");
    currentDetailId = id;

    const commsObj = commentsDB[id] || {};
    let commsArr = [];
    if (Array.isArray(commsObj)) {
        commsArr = commsObj;
    } else {
        commsArr = Object.keys(commsObj).map(k => ({ id: k, ...commsObj[k] }));
        commsArr.sort((a,b) => {
            const da = a.date ? new Date(a.date) : 0;
            const dbb = b.date ? new Date(b.date) : 0;
            return dbb - da;
        });
    }

    const savedName = localStorage.getItem(USER_NAME_KEY) || "";

    try {
        const newUrl = `${location.pathname}?app=${id}`;
        if (!skipPush) {
            history.pushState({p:1}, '', newUrl);
        } else {
            history.replaceState({p:1}, '', newUrl);
        }
    } catch (e) {}

    document.getElementById('detailContent').innerHTML = `
        <i class="fa-solid fa-arrow-left" onclick="history.back()" style="font-size:24px; cursor:pointer; margin-bottom:15px;"></i>
        <div style="display:flex; gap:15px; margin-bottom:20px; align-items:center;">
            <img src="${p.icon}" style="width:72px; height:72px; border-radius:18px;" onerror="this.src='https://via.placeholder.com/150'">
            <div><h3>${escapeHtml(p.name)}</h3><p style="color:var(--primary); font-size:13px;">${escapeHtml(p.dev || '')}</p></div>
        </div>
        <button class="btn-download" onclick="window.open('${p.dLink}')">Download</button>
        <div style="margin-top:8px;">
            <button class="share-btn share-primary" onclick="shareApp(${id})">
                <i class="fa-solid fa-share-nodes"></i> Share
            </button>
            <button id="commentBtn" class="share-btn" style="margin-left:10px;" onclick="focusComment(${id}, event)">
                <i class="fa-regular fa-comment"></i> Comment
            </button>
            <button id="likeBtn" class="like-btn" style="margin-left:10px;" onclick="toggleLike(${id}, event)">
                <!-- updated by updateDetailStats -->
                Loading...
            </button>
        </div>
        <div id="statBoxHolder" class="stat-box">
            <div><b>${escapeHtml(String(p.rating || ''))} ★</b><br><small>Rating</small></div>
            <div><b id="commentCount">${commsArr.length}</b><br><small>Comments</small></div>
            <div><b id="viewsCount">0</b><br><small>Views</small></div>
            <div><b id="likesCount">0</b><br><small>Likes</small></div>
        </div>
        <h4 style="margin:15px 0 10px;">Screenshots</h4>
        <div style="display:flex; gap:10px; overflow-x:auto; scrollbar-width:none;">
            ${(p.ss || []).map(s=>`<img src="${s}" class="ss-img" onclick="zoomImage('${s}')" onerror="this.src='https://via.placeholder.com/600x400'">`).join('')}
        </div>
        <h4 style="margin:20px 0 10px;">About</h4>
        <div class="desc" style="color:gray; font-size:14px; line-height:1.5;">${linkify(p.desc || '')}</div>

        <div class="comment-section">
            <h4>Comments</h4>
            <input type="text" id="cUserName" placeholder="Your Name" value="${escapeHtml(savedName)}" style="margin-bottom:5px;">
            <textarea id="cText" placeholder="Write a comment..." rows="2"></textarea>
            <button class="btn-download" style="margin:10px 0;" onclick="postComment(${id})">Post Comment</button>
            <div id="commentList">
                ${commsArr.map(c => `
                    <div class="comment-item">
                        <div class="comment-user">${escapeHtml(c.name || 'Anonymous')}</div>
                        <div class="comment-text">${escapeHtml(c.comment || '')}</div>
                        <div class="comment-date">${ formatDate(c.date) }</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    document.getElementById('detailPage').style.display = 'block';

    // Register a view for this account (only one view per account)
    registerView(id);

    // Update likes/views UI counts and like button state
    updateDetailStats(id);

    // ensure comment button shows updated comment count (in case comments changed)
    const commentCountEl = document.getElementById('commentCount');
    if (commentCountEl) commentCountEl.innerText = commsArr.length;
}
window.openDetail = openDetail;

/* Register a view for an app for the current user. Only first view from this account increments. */
async function registerView(appId) {
    try {
        const userId = ensureUserId();
        if (!viewsDB[appId]) viewsDB[appId] = {};
        if (viewsDB[appId][userId]) {
            // already viewed from this account - no-op
            updateDetailStats(appId);
            return;
        }
        // mark locally
        viewsDB[appId][userId] = true;
        localStorage.setItem(VIEWS_KEY, JSON.stringify(viewsDB));
        updateDetailStats(appId);
        render(); // update grid counts

        // update firebase (set a presence entry under /views/{appId}/{userId} = true)
        if (fbAvailable && rdb) {
            try {
                await set(rdbRef(rdb, `views/${appId}/${userId}`), true);
            } catch (e) {
                console.warn("Failed to set view in firebase:", e);
            }
        }
    } catch (e) {
        console.warn("registerView error:", e);
    }
}
window.registerView = registerView;

/* Toggle like for current user on an app.
   Enforces one like per account (userId key). If user already liked, this implementation allows unliking (toggle).
   If you want to prevent unliking, change toggle logic to ignore when already liked.
*/
async function toggleLike(appId, event) {
    event && event.stopPropagation && event.stopPropagation();
    const userId = ensureUserId();
    if (!likesDB[appId]) likesDB[appId] = {};
    const already = !!likesDB[appId][userId];
    if (already) {
        // Unlike (toggle). If you want to disable unliking, return here.
        delete likesDB[appId][userId];
    } else {
        likesDB[appId][userId] = true;
    }
    localStorage.setItem(LIKES_KEY, JSON.stringify(likesDB));
    updateDetailStats(appId);
    render(); // update grid counts

    // sync to firebase under /likes/{appId}/{userId} = true/removed
    if (fbAvailable && rdb) {
        try {
            if (already) {
                // remove like
                await set(rdbRef(rdb, `likes/${appId}/${userId}`), null);
            } else {
                await set(rdbRef(rdb, `likes/${appId}/${userId}`), true);
            }
        } catch (e) {
            console.warn("Failed to sync like to firebase:", e);
        }
    }
}
window.toggleLike = toggleLike;

/* Update counts and like button appearance inside detail view */
function updateDetailStats(appId) {
    try {
        const likesCountEl = document.getElementById('likesCount');
        const viewsCountEl = document.getElementById('viewsCount');
        const likeBtn = document.getElementById('likeBtn');
        const userId = ensureUserId();

        const likesForApp = likesDB[appId] || {};
        const viewsForApp = viewsDB[appId] || {};

        const likesCount = Object.keys(likesForApp).length;
        const viewsCount = Object.keys(viewsForApp).length;

        if (likesCountEl) likesCountEl.innerText = likesCount;
        if (viewsCountEl) viewsCountEl.innerText = viewsCount;

        if (likeBtn) {
            const liked = !!likesForApp[userId];
            if (liked) {
                likeBtn.className = 'like-active';
                likeBtn.innerHTML = `<i class="fa-solid fa-heart"></i> Liked`;
            } else {
                likeBtn.className = 'share-btn';
                likeBtn.innerHTML = `<i class="fa-regular fa-heart"></i> Like`;
            }
        }

        // update comment count (if detail open)
        const commsObj = commentsDB[appId] || {};
        const commentCount = Array.isArray(commsObj) ? commsObj.length : Object.keys(commsObj || {}).length;
        const commentCountEl = document.getElementById('commentCount');
        if (commentCountEl) commentCountEl.innerText = commentCount;

    } catch (e) {
        console.warn("updateDetailStats error:", e);
    }
}

/* Focus comment (unchanged) */
function focusComment(appId, event) {
    event && event.stopPropagation && event.stopPropagation();
    if (!currentDetailId || Number(currentDetailId) !== Number(appId)) {
        openDetail(appId);
        setTimeout(() => {
            const t = document.getElementById('cText');
            if (t) t.focus();
        }, 300);
    } else {
        const t = document.getElementById('cText');
        if (t) t.focus();
    }
}
window.focusComment = focusComment;

/* Share function (unchanged) */
async function shareApp(id) {
    const p = db.find(x => Number(x.id) === Number(id));
    if (!p) return alert("Project not found");
    const shareUrl = `${location.origin}${location.pathname}?app=${id}`;
    const shareTitle = p.name || 'Mega store';
    const shareText = p.desc ? p.desc.slice(0, 140) : `Check out ${p.name} on Mega store`;

    if (navigator.share) {
        try {
            await navigator.share({ title: shareTitle, text: shareText, url: shareUrl });
            return;
        } catch (e) {}
    }
    if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
            await navigator.clipboard.writeText(shareUrl);
            alert("Link copied to clipboard! Share it with others.");
            return;
        } catch (e) {}
    }
    prompt("Copy and share this link:", shareUrl);
}
window.shareApp = shareApp;

function formatDate(d) {
    if (!d) return '';
    try {
        const dt = new Date(d);
        if (isNaN(dt)) return d;
        return dt.toLocaleString();
    } catch (e) {
        return d;
    }
}

/* Image zoom */
function zoomImage(src) {
    const zm = document.getElementById('zoomImg');
    if (zm) zm.src = src;
    const overlay = document.getElementById('zoomOverlay');
    if (overlay) overlay.style.display = 'flex';
    history.pushState({zoom:1}, '');
}
window.zoomImage = zoomImage;

/* Post comment (unchanged) */
async function postComment(appId) {
    try {
        const nameInputEl = document.getElementById('cUserName');
        const textEl = document.getElementById('cText');
        const nameInput = nameInputEl ? nameInputEl.value.trim() : '';
        const commentInput = textEl ? textEl.value.trim() : '';

        if (!nameInput || !commentInput) {
            alert("Please enter both name and comment.");
            return;
        }
        localStorage.setItem(USER_NAME_KEY, nameInput);

        const newComment = { name: nameInput, comment: commentInput, date: new Date().toISOString() };

        console.log('postComment ->', { appId, newComment, fbAvailable });

        // Try Firebase push if available
        if (fbAvailable && typeof rdb !== 'undefined' && rdb) {
            try {
                const path = `comments/${appId}`;
                console.log('Attempting Firebase push to', path);
                const pushedRef = await push(rdbRef(rdb, path), newComment);
                console.log('Firebase push success. key=', pushedRef ? pushedRef.key : '(no-key)');
                if (textEl) textEl.value = '';
                return;
            } catch (e) {
                console.error('Firebase push failed:', e);
            }
        } else {
            console.log('Firebase unavailable, using local fallback for comments.');
        }

        // Local fallback
        if (!commentsDB[appId] || typeof commentsDB[appId] !== 'object') commentsDB[appId] = {};
        const cid = 'l_' + Date.now();
        commentsDB[appId][cid] = newComment;
        localStorage.setItem(COMMENT_KEY, JSON.stringify(commentsDB));
        if (textEl) textEl.value = '';
        openDetail(appId, true);
    } catch (err) {
        console.error('postComment unexpected error:', err);
        alert('Could not post comment. Check console for details.');
    }
}
window.postComment = postComment;

/* Upload modal controls and submission (modified to use uploadFilesSequential_User) */
function openUploadModal() {
    const m = document.getElementById('uploadModal');
    if (m) m.style.display = 'flex';
    // defaults
    document.getElementById('u_name').value = '';
    document.getElementById('u_dev').value = 'Sketchwar';
    document.getElementById('u_rating').value = '4.5';
    // default to the new "New" main type
    const hiddenCat = document.getElementById('u_cat');
    if (hiddenCat) hiddenCat.value = 'New';

    // sync custom select UI if present
    try { syncCustomSelectUI(); } catch(e){}

    // clear file inputs and previews
    ['u_icon_file','u_s1_file','u_s2_file','u_s3_file','u_s4_file'].forEach(id=>{
        const el = document.getElementById(id); if(el) el.value='';
        const prev = document.getElementById(id.replace('_file','_preview')); if(prev) { prev.style.display='none'; prev.src=''; }
    });
    document.getElementById('u_desc').value = '';
    document.getElementById('u_link').value = '';
    const disp = document.getElementById('uploadTimeDisplayUser'); if(disp) disp.innerText = '';
    setUserUploadProgress('');
    // ensure small-preview default is applied
    const previewToggle = document.getElementById('u_preview_small');
    if (previewToggle) previewToggle.checked = true;
}
window.openUploadModal = openUploadModal;

function closeUploadModal() {
    const m = document.getElementById('uploadModal');
    if (m) m.style.display = 'none';
}
window.closeUploadModal = closeUploadModal;

// helper for displaying upload time in user modal
function displayUploadTimeUser(ms){
    const el = document.getElementById('uploadTimeDisplayUser');
    if(el){
        el.innerText = `Upload ka total samay: ${ (ms/1000).toFixed(2) }s`;
    } else {
        alert(`Upload ka total samay: ${ (ms/1000).toFixed(2) }s`);
    }
}

async function submitUpload() {
    const btn = document.getElementById('submitUploadBtn');
    const original = btn ? btn.innerHTML : 'Upload App';
    const startTime = performance.now();
    try {
        const name = document.getElementById('u_name').value.trim();
        const iconFile = document.getElementById('u_icon_file').files[0];
        if (!name || !iconFile) return alert("Please provide Project Name and Icon image.");

        if (btn) { btn.disabled = true; btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Uploading...`; }

        const id = Date.now();
        const p = {
            id,
            name,
            dev: document.getElementById('u_dev').value.trim(),
            rating: document.getElementById('u_rating').value.trim() || "4.5",
            icon: '',
            cat: document.getElementById('u_cat').value,
            desc: document.getElementById('u_desc').value.trim(),
            dLink: document.getElementById('u_link').value.trim() || "",
            ss: []
        };

        // build upload list (icon first)
        const uploads = [];
        uploads.push({ file: iconFile, path: `apps/${id}/icon_${Date.now()}_${iconFile.name}` });
        for(const sid of ['u_s1_file','u_s2_file','u_s3_file','u_s4_file']){
            const f = document.getElementById(sid).files[0];
            if(f){
                uploads.push({ file: f, path: `apps/${id}/ss_${Date.now()}_${f.name}` });
            }
        }

        setUserUploadProgress('Starting upload...');
        let uploadedUrls = [];
        try {
          uploadedUrls = await uploadFilesSequential_User(uploads, (overallPercent, doneCount, filePercent, idx) => {
            setUserUploadProgress(`Uploading: ${overallPercent}% (${doneCount}/${uploads.length}) — file ${idx+1}: ${filePercent}%`);
          });
        } catch (e) {
          console.warn("uploadFilesSequential_User error", e);
        }

        // map uploadedUrls
        let cur = 0;
        p.icon = uploadedUrls[cur++] || '';
        for (; cur < uploadedUrls.length; cur++) {
          if (uploadedUrls[cur]) p.ss.push(uploadedUrls[cur]);
        }

        // add locally first
        db.unshift(p);
        localStorage.setItem(DB_KEY, JSON.stringify(db));
        render();

        // write to firebase apps/{id} (creates new)
        if (fbAvailable && rdb) {
            try {
                await set(rdbRef(rdb, `apps/${p.id}`), p);
                const elapsed = performance.now() - startTime;
                displayUploadTimeUser(elapsed);
                setUserUploadProgress('Upload complete.');
                alert("App uploaded successfully.");
                closeUploadModal();
                tab('home', document.getElementById('nav-home'));
                return;
            } catch (e) {
                console.warn("Firebase write failed", e);
                const elapsed = performance.now() - startTime;
                displayUploadTimeUser(elapsed);
                setUserUploadProgress('Upload complete (local fallback).');
                alert("Saved locally, but Firebase write failed.");
                closeUploadModal();
                tab('home', document.getElementById('nav-home'));
                return;
            }
        } else {
            const elapsed = performance.now() - startTime;
            displayUploadTimeUser(elapsed);
            setUserUploadProgress('Upload complete (local).');
            alert("Saved locally. Firebase not available.");
            closeUploadModal();
            tab('home', document.getElementById('nav-home'));
            return;
        }
    } catch (err) {
        console.error("submitUpload error:", err);
        alert("Upload failed. Check console for details.");
    } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = original; }
    }
}
window.submitUpload = submitUpload;

function saveUploadLocally() {
    const name = document.getElementById('u_name').value.trim();
    const iconFile = document.getElementById('u_icon_file').files[0];
    if (!name || !iconFile) return alert("Please provide Project Name and Icon image.");
    (async ()=>{
        const startTime = performance.now();
        const id = Date.now();
        const p = {
            id,
            name,
            dev: document.getElementById('u_dev').value.trim(),
            rating: document.getElementById('u_rating').value.trim() || "4.5",
            icon: '',
            cat: document.getElementById('u_cat').value,
            desc: document.getElementById('u_desc').value.trim(),
            dLink: document.getElementById('u_link').value.trim() || "",
            ss: []
        };

        // convert icon + screenshots sequentially with progress
        const files = [];
        files.push({ file: iconFile });
        for(const sid of ['u_s1_file','u_s2_file','u_s3_file','u_s4_file']){
            const f = document.getElementById(sid).files[0];
            if(f) files.push({ file: f });
        }

        setUserUploadProgress('Converting images locally...');
        const results = [];
        let done = 0;
        for (let i = 0; i < files.length; i++) {
          try {
            const url = await fileToDataURLWithProgressUser(files[i].file, (pcent) => {
              const overall = files.length ? Math.round(((done + (pcent/100)) / files.length) * 100) : 100;
              setUserUploadProgress(`Saving locally: ${overall}% (${done}/${files.length}) — file ${i+1}: ${pcent}%`);
            });
            results.push(url);
            done++;
            setUserUploadProgress(`Saving locally: ${Math.round((done / files.length) * 100)}% (${done}/${files.length})`);
          } catch (e) {
            console.warn('dataURL conversion failed', e);
            results.push('');
          }
        }

        // map results
        let idx = 0;
        p.icon = results[idx++] || '';
        for (; idx < results.length; idx++) {
          if (results[idx]) p.ss.push(results[idx]);
        }

        db.unshift(p);
        localStorage.setItem(DB_KEY, JSON.stringify(db));
        render();
        const elapsed = performance.now() - startTime;
        displayUploadTimeUser(elapsed);
        setUserUploadProgress('Saved locally.');
        alert("App saved locally.");
        closeUploadModal();
        tab('home', document.getElementById('nav-home'));
    })();
}
window.saveUploadLocally = saveUploadLocally;

/* Search + navigation + tab (unchanged behavior except app-card snippet) */
function doSearch() {
    const qRaw = document.getElementById('searchInput').value || '';
    const q = qRaw.trim().toLowerCase();
    const homeV = document.getElementById('home-view'), allV = document.getElementById('all-view'), searchV = document.getElementById('search-view'), res = document.getElementById('searchResults'), newsV = document.getElementById('news-view');

    if (q.length > 0) {
        if (currentTab === 'news' || (newsV && newsV.style.display === 'block')) {
            const filtered = (newsDB || []).filter(n => {
                const t = (n.title || '').toLowerCase();
                const d = (n.desc || '').toLowerCase();
                return t.includes(q) || d.includes(q);
            });
            renderNews(filtered);
            newsV.style.display = 'block';
            homeV.style.display = 'none';
            allV.style.display = 'none';
            searchV.style.display = 'none';
            return;
        }

        if (newsV) newsV.style.display = 'none';
        homeV.style.display = 'none'; allV.style.display = 'none'; searchV.style.display = 'block';
        let html = "";
        db.filter(p => (p.name || '').toLowerCase().includes(q) || (p.dev || '').toLowerCase().includes(q)).forEach(p => {
            const likesCount = countFor(likesDB, p.id);
            const viewsCount = countFor(viewsDB, p.id);
            const statsHTML = `<div class="app-stats">
                                  <div class="stat" title="Views"><i class="fa-solid fa-eye"></i><div class="num">${escapeHtml(String(viewsCount || 0))}</div></div>
                                  <div class="stat" title="Likes"><i class="fa-solid fa-heart"></i><div class="num">${escapeHtml(String(likesCount || 0))}</div></div>
                               </div>`;
            html += `<div class="app-card" onclick="openDetail(${p.id})"><div class="icon-box"><img src="${p.icon}" onerror="this.src='https://via.placeholder.com/150'"></div><div class="app-name">${escapeHtml(p.name)}</div>${statsHTML}</div>`;
        });
        res.innerHTML = html || "<p style='grid-column: span 3; color:gray; text-align:center;'>No Results</p>";
    } else {
        document.getElementById('search-view').style.display = 'none';
        if (currentTab === 'news') {
            tab('news', document.getElementById('nav-news'));
        } else {
            tab(currentTab, document.querySelector(`.nav-item[onclick*='${currentTab}']`));
        }
    }
}
window.doSearch = doSearch;

function tab(type, el) {
    currentTab = type;
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    if (el) el.classList.add('active');
    document.getElementById('search-view').style.display = 'none';
    document.getElementById('home-view').style.display = type === 'home' ? 'block' : 'none';
    document.getElementById('all-view').style.display = type === 'all' ? 'block' : 'none';
    document.getElementById('news-view').style.display = type === 'news' ? 'block' : 'none';
    if (type === 'news') {
        renderNews();
    }
}
window.tab = tab;

function goToAll() { tab('all', document.getElementById('nav-all')); }
window.goToAll = goToAll;

/* ------------------ Custom select implementation ------------------ */
/* Initialize custom select: attaches event listeners and sets initial state */
function initCustomSelect() {
  const wrapper = document.getElementById('u_cat_custom');
  const hidden = document.getElementById('u_cat');
  if (!wrapper || !hidden) return;

  const selected = wrapper.querySelector('.selected');
  const optionsEl = wrapper.querySelector('.options');
  const optionEls = Array.from(wrapper.querySelectorAll('.option'));

  // toggle open
  wrapper.addEventListener('click', (e) => {
    e.stopPropagation();
    const isOpen = wrapper.classList.toggle('open');
    wrapper.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    optionsEl.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
  });

  // choose option
  optionEls.forEach(opt => {
    opt.addEventListener('click', (ev) => {
      ev.stopPropagation();
      const v = opt.innerText.trim();
      selected.innerText = v;
      hidden.value = v;
      // mark active
      optionEls.forEach(o => o.classList.remove('active'));
      opt.classList.add('active');
      wrapper.classList.remove('open');
      wrapper.setAttribute('aria-expanded', 'false');
      optionsEl.setAttribute('aria-hidden', 'true');
    });
  });

  // keyboard support
  wrapper.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter' || ev.key === ' ') {
      ev.preventDefault();
      const isOpen = wrapper.classList.toggle('open');
      wrapper.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      optionsEl.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
    } else if (ev.key === 'Escape') {
      wrapper.classList.remove('open');
      wrapper.setAttribute('aria-expanded', 'false');
      optionsEl.setAttribute('aria-hidden', 'true');
    } else if (ev.key === 'ArrowDown' || ev.key === 'ArrowUp') {
      ev.preventDefault();
      let idx = optionEls.findIndex(o => o.classList.contains('active'));
      if (idx === -1) idx = 0;
      if (ev.key === 'ArrowDown') idx = Math.min(optionEls.length - 1, idx + 1);
      if (ev.key === 'ArrowUp') idx = Math.max(0, idx - 1);
      optionEls.forEach(o => o.classList.remove('active'));
      optionEls[idx].classList.add('active');
      optionEls[idx].scrollIntoView({ block: 'nearest' });
    }
  });

  // close when clicking outside
  document.addEventListener('click', () => {
    wrapper.classList.remove('open');
    wrapper.setAttribute('aria-expanded', 'false');
    optionsEl.setAttribute('aria-hidden', 'true');
  });

  // set default active based on hidden.value
  syncCustomSelectUI();
}

/* Sync custom select UI with hidden input value */
function syncCustomSelectUI() {
  const wrapper = document.getElementById('u_cat_custom');
  const hidden = document.getElementById('u_cat');
  if (!wrapper || !hidden) return;
  const selected = wrapper.querySelector('.selected');
  const optionEls = Array.from(wrapper.querySelectorAll('.option'));
  const current = (hidden.value || '').trim() || 'New';
  const match = optionEls.find(o => o.innerText.trim() === current);
  if (match) {
    optionEls.forEach(o => o.classList.remove('active'));
    match.classList.add('active');
    selected.innerText = current;
  } else {
    optionEls.forEach(o => o.classList.remove('active'));
    optionEls[0].classList.add('active');
    selected.innerText = optionEls[0].innerText.trim();
    hidden.value = optionEls[0].innerText.trim();
  }
}
/* ---------------- end custom select ------------------ */

 /* Expose internals for debugging */
window._MEGA_INTERNAL = {
    get db() { return db; },
    get commentsDB() { return commentsDB; },
    get newsDB() { return newsDB; },
    get likesDB() { return likesDB; },
    get viewsDB() { return viewsDB; },
    fbAvailable
} ;

</script>
</body>
</html>